<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Cyber Range: CTF Edition</title>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar for Missions */
        #mission-panel {
            width: 30%;
            background-color: #1e1e1e;
            border-right: 2px solid #333;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        h2, h3 { margin-top: 0; color: #00ff41; }
        .mission-box {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #00ff41;
            margin-bottom: 20px;
        }
        .status-bar {
            margin-top: auto;
            padding: 10px;
            background: #000;
            border: 1px solid #333;
            color: #ffb700;
        }

        /* Main Terminal Area */
        #terminal-container {
            width: 70%;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background-color: #0d1117;
        }
        #output {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        .input-line { display: flex; align-items: center; }
        .prompt { color: #2ea44f; font-weight: bold; margin-right: 10px; }
        #cmd-input {
            background: transparent;
            border: none;
            color: #fff;
            font-family: inherit;
            font-size: 16px;
            flex-grow: 1;
            outline: none;
        }

        /* Utility Classes */
        .success { color: #00ff41; font-weight: bold; }
        .error { color: #ff5555; }
        .info { color: #79c0ff; }
        .log-entry { color: #a5d6ff; }

        .answer-area {
            margin-top: 20px;
            padding: 15px;
            background: #2d2d2d;
            border-radius: 5px;
            border-left: 4px solid #ffb700;
        }
        .answer-area input {
            width: calc(100% - 100px);
            background: #121212;
            border: 1px solid #333;
            color: #fff;
            padding: 8px;
            font-family: inherit;
            font-size: 14px;
            margin-right: 10px;
        }
        .answer-area button {
            width: 80px;
            padding: 8px;
            background: #2ea44f;
            border: none;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
        }
        #hint-btn {
            background: none;
            border: 1px solid #79c0ff;
            color: #79c0ff;
            padding: 5px 10px;
            cursor: pointer;
            margin-top: 10px;
            display: inline-block;
        }
        #hint-text {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #000;
            border: 1px solid #333;
        }
    </style>
</head>
<body>

    <div id="mission-panel">
        <h2>üõ°Ô∏è Cyber Range</h2>
        <div id="mission-display" class="mission-box">
            <h3 id="level-title">Level 1: The Hidden File</h3>
            <p id="mission-narrative" class="info"></p>
            <p id="level-desc">A user reported suspicious files. List all files in the current directory (including hidden ones). Find the hidden file name.</p>
            <button id="hint-btn">Show Hint</button>
            <div id="hint-text"></div>
        </div>
        <div class="answer-area">
            <label for="answer-input">Your Answer:</label><br><br>
            <input type="text" id="answer-input" placeholder="Enter the flag here...">
            <button id="submit-answer-btn">Submit</button>
        </div>
        <div class="status-bar">
            Current Rank: <span id="rank-display">Trainee Analyst</span><br>
            Current Score: <span id="score">0</span> / 400 XP
        </div>
    </div>

    <div id="terminal-container">
        <div id="output">
            <div>Welcome to the Cyber Defense Simulator v2.0</div>
            <div>Type 'help' for commands. Submit answers in the answer box.</div>
            <div>---------------------------------------------------------------</div>
        </div>
        <div class="input-line">
            <span class="prompt" id="prompt-text">analyst@workstation:~</span>
            <input type="text" id="cmd-input" autofocus autocomplete="off">
        </div>
    </div>

    <script>
        // --- GAME STATE & DATA --- 
        let currentLevelIndex = 0;
        let currentScenarioIndex = 0;
        let currentStepIndex = 0;
        let score = 0;
        const commandHistory = [];
        let historyIndex = -1;
        const availableCommands = ['ls', 'cat', 'grep', 'nmap', 'clear', 'help', 'netdiscover'];

        // Define the entire game structure with levels, scenarios, and steps
        const gameData = [
            {
                levelTitle: "Level 1: Basic Reconnaissance & File Forensics",
                levelStory: "Welcome, Analyst! Your journey begins with foundational skills in network reconnaissance and file system investigation. The 'Cyber Defense Unit' needs you to prove your capabilities in understanding basic system vulnerabilities and data recovery.",
                scenarios: [
                    {
                        scenarioTitle: "Scenario 1: Hidden File Discovery",
                        objective: "A server recovered from a suspected insider threat contains hidden files. Your objective is to find the hidden configuration file left behind.",
                        hint: "Hidden files in Linux often start with a dot (.). The 'ls' command might have options to reveal them.",
                        debrief: "Understanding how to reveal hidden files is crucial for forensic analysis and discovering malicious payloads or configuration details. This skill is foundational for further investigations.",
                        xp: 100,
                        steps: [
                            {
                                type: 'command',
                                expectedCommand: /^ls\s+-a$/,
                                successMessage: "You successfully listed all files, including hidden ones. Good job!",
                                failureMessage: "That command didn't work as expected. Remember, hidden files often start with a dot (.).",
                                virtualOutput: "notes.txt  .creds.txt  auth.log  malware.py"
                            }
                        ],
                        answer: ".creds.txt" // The flag for this scenario is the filename
                    },
                    {
                        scenarioTitle: "Scenario 2: Network Host Identification",
                        objective: "Your objective is to perform a network discovery scan to find the target server's IP address.",
                        hint: "You need a command to scan the network for active hosts. Think network discovery tools like 'netdiscover'.",
                        debrief: "Network discovery is the first step in understanding a target environment. Identifying live hosts is crucial before you can assess their services and potential vulnerabilities. It's like finding a house before you try to open its doors.",
                        xp: 100,
                        steps: [
                            {
                                type: 'command',
                                expectedCommand: /^netdiscover$/,
                                successMessage: "Network scan completed. You've identified several hosts on the network. Look for the 'Target-Server' IP.",
                                failureMessage: "The network discovery command did not yield results. Make sure you're using the correct tool.",
                                virtualOutput: ` Currently scanning: 10.10.5.0/24   |   Screen will be updated every 5 seconds ...
 
 200 hosts total, 100 hosts active
 
 IP              MAC               Name
 -----------------------------------------------------------------------------
 10.10.5.1       00:50:56:c0:00:08 Router
 10.10.5.10      00:1c:23:45:67:89 Workstation-A
 10.10.5.50      08:00:27:12:34:56 Target-Server
 10.10.5.200     00:0c:29:ab:cd:ef Attacker-VM`
                            }
                        ],
                        answer: "10.10.5.50" // The flag for this scenario is the IP
                    },
                    {
                        scenarioTitle: "Scenario 3: Service Port Identification",
                        objective: "Now that you've found the target server, your objective is to identify its open services and find the port number of the database service.",
                        hint: "You need to scan for open ports on the target IP. 'nmap' is the tool for this. Remember to specify the target IP!",
                        debrief: "Port scanning is vital for vulnerability assessment. Identifying open services helps both attackers and defenders understand the attack surface of a system. Common ports often reveal common services.",
                        xp: 100,
                        steps: [
                            {
                                type: 'command',
                                expectedCommand: /^nmap\s+10\.10\.5\.50$/,
                                successMessage: "Port scan completed successfully. Analyze the output for the database port.",
                                failureMessage: "The port scan command failed. Ensure you're scanning the correct IP with 'nmap'.",
                                virtualOutput: `Starting Nmap 7.94 at 2025-11-19...
Host is up (0.00045s latency).
Not shown: 997 closed tcp ports (reset)
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
3306/tcp open  mysql

Nmap done: 1 IP address (1 host up) scanned in 1.24 seconds`
                            }
                        ],
                        answer: "3306" // The flag for this scenario is the database port
                    },
                    {
                        scenarioTitle: "Scenario 4: Malicious Payload Identification",
                        objective: "Critical alert! We've quarantined a suspicious Python script from a compromised workstation. Your objective is to analyze the code, identify the obfuscated payload, and extract the variable name holding the malicious string.",
                        hint: "Use 'cat malware.py'. The answer is the variable name holding the suspicious string, not the string itself.",
                        debrief: "Identifying malicious code and its components is a core skill in incident response. Knowing where to look (e.g., specific variable names) can accelerate remediation efforts.",
                        xp: 100,
                        steps: [
                            {
                                type: 'command',
                                expectedCommand: /^cat\s+malware\.py$/,
                                successMessage: "You've successfully viewed the contents of malware.py. Now, identify the variable.",
                                failureMessage: "That command didn't work. Make sure you're using 'cat' on the correct filename.",
                                virtualOutput: `import os
# Suspicious script found in /tmp
def connect():
    payload_str = "aHR0cDovL2V2aWwuY29t" # This looks suspicious...
    os.system(payload_str)`
                            }
                        ],
                        answer: "payload_str"
                    }
                ]
            }
        ];

        const fileSystem = {
            "notes.txt": "Meeting at 10am. Don't forget to patch the server.",
            ".creds.txt": "admin:SuperSecretPassword! (You found it!)",
            "auth.log": `Nov 10 12:00:01 server sshd[123]: Accepted password for root from 10.0.0.5 port 22
Nov 10 12:05:22 server sshd[456]: Failed password for invalid user admin from 192.168.1.200 port 4492
Nov 10 12:05:24 server sshd[456]: Failed password for invalid user admin from 192.168.1.200 port 4492
Nov 10 12:05:26 server sshd[456]: Failed password for invalid user admin from 192.168.1.200 port 4492
Nov 10 12:10:00 server sshd[789]: Connection closed by 192.168.1.200`,
            "malware.py": `import os
# Suspicious script found in /tmp
def connect():
    payload_str = "aHR0cDovL2V2aWwuY29t" # This looks suspicious...
    os.system(payload_str)`
        };

        // --- DOM ELEMENTS ---
        const outputDiv = document.getElementById('output');
        const inputField = document.getElementById('cmd-input');
        const missionTitle = document.getElementById('level-title');
        const missionNarrative = document.getElementById('mission-narrative'); // New
        const missionDesc = document.getElementById('level-desc');
        const scoreDisplay = document.getElementById('score');
        const rankDisplay = document.getElementById('rank-display'); // New
        const hintBtn = document.getElementById('hint-btn');
        const hintText = document.getElementById('hint-text');
        const answerInput = document.getElementById('answer-input');
        const submitAnswerBtn = document.getElementById('submit-answer-btn');

        // --- CORE FUNCTIONS ---
        function print(text, type = '') {
            const div = document.createElement('div');
            div.className = type;
            // Using innerHTML here for pre-formatted output like netdiscover, but sanitize if from user input
            // For now, only trusted internal output is passed.
            div.innerHTML = text; 
            outputDiv.appendChild(div);
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        function getRank(currentScore) {
            if (currentScore >= 400) return "Senior Cyber Analyst";
            if (currentScore >= 300) return "Cyber Analyst";
            if (currentScore >= 200) return "Associate Analyst";
            if (currentScore >= 100) return "Junior Analyst";
            return "Trainee Analyst";
        }

        // --- NEW GAME LOGIC ---

        function getCurrentLevelData() {
            return gameData[currentLevelIndex];
        }

        function getCurrentScenarioData() {
            const level = getCurrentLevelData();
            return level ? level.scenarios[currentScenarioIndex] : null;
        }

        function getCurrentStepData() {
            const scenario = getCurrentScenarioData();
            return scenario ? scenario.steps[currentStepIndex] : null;
        }

        // --- NEW GAME LOGIC ---

        function getCurrentLevelData() {
            return gameData[currentLevelIndex];
        }

        function getCurrentScenarioData() {
            const level = getCurrentLevelData();
            return level ? level.scenarios[currentScenarioIndex] : null;
        }

        function getCurrentStepData() {
            const scenario = getCurrentScenarioData();
            return scenario ? scenario.steps[currentStepIndex] : null;
        }

        function updateMissionDisplay() {
            const currentLevel = getCurrentLevelData();
            const currentScenario = getCurrentScenarioData();

            if (!currentLevel) { // All levels complete
                missionTitle.textContent = "üéâ TRAINING COMPLETE";
                missionNarrative.textContent = "You have successfully completed all missions and are a true Cyber Defender!";
                missionDesc.textContent = "Thank you for playing the Gemini Cyber Range: CTF Edition.";
                hintBtn.style.display = 'none';
                hintText.style.display = 'none';
                document.querySelector('.answer-area').style.display = 'none';
                missionDesc.style.color = "#00ff41";
                return;
            }

            if (!currentScenario) { // All scenarios in current level complete
                print(`‚úÖ Level ${currentLevelIndex + 1} Complete! Advancing to next level...`, "success");
                currentLevelIndex++;
                currentScenarioIndex = 0; // Reset scenario index for next level
                currentStepIndex = 0; // Reset step index for next level
                updateMissionDisplay(); // Recurse to load next level
                return;
            }
            
            // Clear terminal for new mission
            outputDiv.innerHTML = `
                <div>Welcome to the Gemini Cyber Defense Simulator v2.0</div>
                <div>Type 'help' for commands. Submit answers in the answer box.</div>
                <div>---------------------------------------------------------------</div>
            `;

            missionTitle.textContent = `${currentLevel.levelTitle}`;
            missionNarrative.textContent = currentLevel.levelStory; // Level story (intro once per level)
            
            missionDesc.textContent = currentScenario.objective;
            hintText.textContent = currentScenario.hint;
            hintText.style.display = 'none';
            hintBtn.textContent = 'Show Hint';
            hintBtn.style.display = 'inline-block';

            rankDisplay.textContent = getRank(score);
            scoreDisplay.textContent = score;

            print(`\n--- ${currentLevel.levelTitle} - ${currentScenario.scenarioTitle} ---\n`, "info");
            print(`Objective: ${currentScenario.objective}\n`, "info");
        }
        
        function submitAnswer() {
            const currentScenario = getCurrentScenarioData();
            if (!currentScenario) {
                print("Error: No active scenario to submit an answer for.", "error");
                return;
            }
            // Ensure all steps are completed before submitting the final answer
            if (currentStepIndex < currentScenario.steps.length) {
                print("Please complete all steps for the current scenario before submitting the final answer.", "error");
                return;
            }

            const userAnswer = answerInput.value.trim();
            if (userAnswer === currentScenario.answer) {
                print(`‚úÖ CORRECT! Scenario ${currentScenario.scenarioTitle} Completed!`, "success");
                answerInput.value = '';
                currentScenarioIndex++; // Move to next scenario
                currentStepIndex = 0; // Reset step index for next scenario
                showDebrief(currentScenario); // Show debrief, which then calls updateMissionDisplay
            } else {
                print(`‚ùå Incorrect answer submitted: ${userAnswer}. Try again!`, "error");
                answerInput.value = '';
            }
        }

        function handleCommand(cmdRaw) {
            const cmd = cmdRaw.trim();
            if (!cmd) return;
            
            commandHistory.unshift(cmd);
            historyIndex = -1;

            print(`analyst@workstation:~$ ${cmd}`, 'log-entry');
            
            const parts = cmd.split(' ');
            const command = parts[0].toLowerCase();
            const args = parts.slice(1);

            const currentScenario = getCurrentScenarioData();
            let currentStep = getCurrentStepData(); // Let so it can be null after advancing

            if (!currentScenario) {
                print("Error: No active scenario.", "error");
                return;
            }
            if (!currentStep) {
                 print("Error: Current scenario has no steps defined or all steps completed. Submit answer to complete scenario.", "error");
                 return;
            }


            let commandHandledByStep = false;
            // Validate against the current expected step
            if (currentStep.type === 'command' && currentStep.expectedCommand) {
                const regex = new RegExp(currentStep.expectedCommand);
                if (regex.test(cmd)) {
                    print(currentStep.successMessage, "success");
                    if (currentStep.virtualOutput) {
                        print(currentStep.virtualOutput);
                    }
                    currentStepIndex++; // Advance to next step
                    commandHandledByStep = true;
                    // Check if scenario is fully stepped through after this
                    if (currentStepIndex >= currentScenario.steps.length) {
                        print(`\nAll steps for Scenario ${currentScenario.scenarioTitle} completed. Please submit your final answer in the answer box.`, "info");
                    }
                } else {
                    print(currentStep.failureMessage, "error");
                    commandHandledByStep = true; // Still considered handled, just failed
                }
            }

            // Fallback for general commands or commands not tied to a specific step
            if (!commandHandledByStep) {
                switch (command) {
                    case 'help':
                        print("Available Commands:");
                        print("  ls [-a]          List files");
                        print("  cat [file]       Read file content");
                        print("  grep [txt] [file] Find text in file");
                        print("  nmap [ip]        Scan a target IP");
                        print("  netdiscover      Perform network discovery");
                        print("  clear            Clear screen");
                        break;

                    case 'clear':
                        outputDiv.innerHTML = '';
                        // Re-print welcome message after clear
                        print(`
                            <div>Welcome to the Gemini Cyber Defense Simulator v2.0</div>
                            <div>Type 'help' for commands. Submit answers in the answer box.</div>
                            <div>---------------------------------------------------------------</div>
                        `);
                        break;

                    case 'ls':
                        if (args.includes('-a')) {
                            print("notes.txt  .creds.txt  auth.log  malware.py", "info");
                        } else {
                            print("notes.txt  auth.log  malware.py", "info");
                        }
                        break;

                    case 'cat':
                        if (args.length === 0) { print("Usage: cat [filename]", "error"); return; }
                        if (fileSystem[args[0]]) {
                            print(fileSystem[args[0]]);
                        } else {
                            print(`cat: ${args[0]}: No such file`, "error");
                        }
                        break;
                    
                    case 'grep':
                        if (args.length < 2) { print("Usage: grep [text] [filename]", "error"); return; }
                        const search = args[0];
                        const file = args[1];
                        if (fileSystem[file]) {
                            const lines = fileSystem[file].split('\n');
                            lines.forEach(line => {
                                if (line.includes(search)) print(line);
                            });
                        } else {
                            print(`grep: ${file}: No such file`, "error");
                        }
                        break;

                    case 'nmap': // This is a generic nmap output, specific scenarios might override with step.virtualOutput
                        if (args.length === 0) { print("Usage: nmap [ip]", "error"); return; }
                        print(`Starting Nmap 7.94...`);
                        setTimeout(() => {
                            print(`Nmap scan report for ${args[0]}`);
                            print(`Host is up.`);
                            print(`PORT     STATE SERVICE`);
                            print(`22/tcp   open  ssh`);
                            print(`80/tcp   open  http`);
                            print(`3306/tcp open  mysql`);
                            print(`Nmap done.`);
                        }, 800);
                        break;

                    case 'netdiscover': // This is a generic netdiscover output, specific scenarios might override with step.virtualOutput
                        print(` Currently scanning: 10.10.5.0/24   |   Screen will be updated every 5 seconds ...`);
                        setTimeout(() => {
                            print(` `);
                            print(` 200 hosts total, 100 hosts active`);
                            print(` `);
                            print(` IP              MAC               Name`);
                            print(` -----------------------------------------------------------------------------`);
                            print(` 10.10.5.1       00:50:56:c0:00:08 Router`);
                            print(` 10.10.5.10      00:1c:23:45:67:89 Workstation-A`);
                            print(` 10.10.5.50      08:00:27:12:34:56 Target-Server`);
                            print(` 10.10.5.200     00:0c:29:ab:cd:ef Attacker-VM`);
                        }, 1500);
                        break;

                    default:
                        print(`bash: ${command}: command not found`, "error");
                }
            }
        }

        // --- EVENT LISTENERS ---
        hintBtn.addEventListener('click', () => {
            const isHidden = hintText.style.display === 'none';
            hintText.style.display = isHidden ? 'block' : 'none';
            hintBtn.textContent = isHidden ? 'Hide Hint' : 'Show Hint';
        });
        
        submitAnswerBtn.addEventListener('click', submitAnswer);
        answerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                submitAnswer();
            }
        });

        inputField.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleCommand(inputField.value);
                inputField.value = '';
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    inputField.value = commandHistory[historyIndex];
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    inputField.value = commandHistory[historyIndex];
                } else {
                    historyIndex = -1;
                    inputField.value = '';
                }
            } else if (e.key === 'Tab') {
                e.preventDefault();
                const currentInput = inputField.value.trim();
                const foundCommand = availableCommands.find(c => c.startsWith(currentInput));
                if (foundCommand) {
                    inputField.value = foundCommand;
                }
            }
        });

        updateMissionDisplay();

    </script>